<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shakespeare JSON Viewer</title>
  <style>
    :root{
      --bg:#0b0b0c; --surface:#101113; --text:#e7e7e7; --muted:#a3a3a3;
      --accent:#b08cff; --border:#2a2d31; --sidebar-w:320px; --reading-w:70ch; --lh:1.6;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#fafafa; --surface:#fff; --text:#121212; --muted:#4b5563; --accent:#5b3fd6; --border:#e5e7eb; }
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/var(--lh) system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,ui-sans-serif}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-bottom:1px solid var(--border);background:var(--surface)}
    header h1{font-size:1rem;margin:0;font-weight:600;letter-spacing:.02em}
    .layout{display:flex;min-height:calc(100vh - 56px)}
    aside{width:var(--sidebar-w);border-right:1px solid var(--border);padding:1rem;overflow:auto;background:var(--surface)}
    main{flex:1;min-width:0;display:flex;flex-direction:column}
    #toolbar{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.75rem 1rem;border-bottom:1px solid var(--border);background:var(--surface)}
    #toolbar button{border:1px solid var(--border);background:transparent;color:var(--text);padding:.35rem .6rem;border-radius:.5rem;font:inherit;cursor:pointer}
    #toolbar button:disabled{opacity:.4;cursor:default}
    #crumbs{font-weight:600;text-align:center;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #content{padding:1.25rem clamp(1rem,6vw,3rem);max-width:var(--reading-w);width:100%;margin:0 auto}
    .heading.scene,.heading.title{margin:.5rem 0 1rem;font-size:1.25rem}
    h1.unit{font-size:1.4rem;margin:.5rem 0 1rem}
    .stage{font-style:italic;color:var(--muted);margin:.25rem 0}
    .speech{margin:.75rem 0 1rem}
    .speaker{margin:.75rem 0 .25rem;font-weight:700;font-size:.95rem;color:var(--accent);text-transform:capitalize}
    .line{margin:.1rem 0;display:grid;grid-template-columns:minmax(4ch,auto) 1fr;gap:.75rem;align-items:flex-start}
    .line-number{color:var(--muted);font-variant-numeric:tabular-nums;text-align:right;user-select:text}
    .line-text{white-space:pre-wrap}
    .play summary{cursor:pointer;font-weight:600}
    .play small.muted{color:var(--muted);font-weight:500}
    ul.scenes{list-style:none;padding:.25rem 0 .5rem .25rem;margin:0}
    ul.scenes li{margin:.15rem 0}
    a.scene-link{color:inherit;text-decoration:none;border-radius:.35rem;padding:.2rem .35rem;display:inline-block}
    a.scene-link:hover{background:rgba(176,140,255,.18)}
    a.scene-link.active{background:rgba(176,140,255,.35)}
    .error{white-space:pre-wrap;background:#ffeded0f;border:1px solid #fca5a5;color:#fecaca;padding:1rem;border-radius:.5rem}
    @media (max-width:920px){aside{display:none}main{border-left:none}}
  </style>
</head>
<body>
  <header><h1>Shakespeare JSON Viewer</h1></header>
  <div class="layout">
    <aside><div id="plays"></div></aside>
    <main>
      <div id="toolbar">
        <button id="prev" disabled>← Prev</button>
        <div id="crumbs">Loading…</div>
        <button id="next" disabled>Next →</button>
      </div>
      <article id="content" aria-live="polite"></article>
    </main>
  </div>

  <script defer>
  (function(){
    'use strict';
    const $ = s => document.querySelector(s);
    function el(tag, attrs={}, ...kids){
      const n = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)){
        if (k==='class') n.className=v;
        else if (k.startsWith('on') && typeof v==='function') n.addEventListener(k.slice(2), v);
        else n.setAttribute(k, v);
      }
      for (const k of kids) n.appendChild(typeof k==='string'?document.createTextNode(k):k);
      return n;
    }

    const state = { index:null, byPath:new Map(), byPlay:new Map(), current:null, cache:new Map() };

    async function loadIndex(){
      const res = await fetch('index.json');               // IMPORTANT: relative path (works at /shakespeare-JSON/)
      if (!res.ok) throw new Error('Failed to load index.json: '+res.status);
      const idx = await res.json();
      state.index = idx;
      state.byPath.clear();
      idx.plays.forEach((p,pi)=>p.scenes.forEach((s,si)=>state.byPath.set(s.path,{playIndex:pi,sceneIndex:si})));
    }

    function renderSidebar(){
      const root = $('#plays'); root.innerHTML = '';
      state.index.plays.forEach(play=>{
        const details = el('details',{class:'play'});
        details.appendChild(el('summary',{}, play.title+' ', el('small',{class:'muted'},`(${play.scene_count})`)));
        const ul = el('ul',{class:'scenes'});
        ul.appendChild(el('li',{}, el('a',{
          href:'#p='+encodeURIComponent(play.id),
          class:'scene-link full',
          'data-play':play.id
        }, 'Full play')));
        play.scenes.forEach(s=>{
          const label = s.title || `Act ${s.act ?? '?'} Scene ${s.scene ?? '?'}`;
          const a = el('a',{href:'#s='+encodeURIComponent(s.path), class:'scene-link', 'data-path':s.path}, label);
          ul.appendChild(el('li',{}, a));
        });
        details.appendChild(ul);
        root.appendChild(details);
      });
    }

    function textFromItem(item){
      const spans = item.spans || [];
      return spans.map(sp=>sp.text || '').join('');
    }

    function renderScene(json,{playTitle:playOverride,unitTitle:unitOverride}={}){
      const playTitle = playOverride || json.meta?.play?.title || json.meta?.play?.id || 'Unknown play';
      let unitTitle;
      if (unitOverride !== undefined) unitTitle = unitOverride;
      else unitTitle = json.meta?.unit?.title || json.meta?.unit?.label || '';
      $('#crumbs').textContent = unitTitle ? `${playTitle} › ${unitTitle}` : playTitle;

      const content = $('#content'); content.innerHTML = '';
      if (unitTitle) content.appendChild(el('h1',{class:'unit'}, unitTitle));

      let lastSpeechId = null, cur = null;
      for (const item of (json.items || [])){
        if (item.kind === 'heading'){
          const level = (item.subtype==='scene' || item.subtype==='title') ? 'h2' : 'h3';
          content.appendChild(el(level,{class:'heading '+(item.subtype||'')}, textFromItem(item)));
          lastSpeechId = null; cur = null;
        } else if (item.kind === 'stage'){
          content.appendChild(el('div',{class:'stage'}, textFromItem(item)));
        } else if (item.kind === 'speech'){
          if (item.speech_id !== lastSpeechId){
            cur = el('section',{class:'speech'});
            const speaker = (item.speaker || '').replaceAll('_',' ').trim();
            if (speaker) cur.appendChild(el('h4',{class:'speaker'}, speaker));
            content.appendChild(cur);
            lastSpeechId = item.speech_id;
          }
          const line = el('p',{class:'line','data-line':item.line_number ?? ''});
          const ln = item.line_number ? String(item.line_number) : '\u00A0';
          line.appendChild(el('span',{class:'line-number'}, ln));
          line.appendChild(el('span',{class:'line-text'}, textFromItem(item)));
          cur.appendChild(line);
        } else if (item.kind === 'speaker_label'){
          cur = el('section',{class:'speech'});
          cur.appendChild(el('h4',{class:'speaker'}, (item.speaker||'').replaceAll('_',' ').trim()));
          content.appendChild(cur);
          lastSpeechId = null;
        }
      }
      content.scrollTop = 0;
    }

    async function fetchJSON(path){
      if (state.cache.has(path)) return state.cache.get(path);
      const res = await fetch(path);
      if (!res.ok) throw new Error(`Failed to load ${path}: ${res.status}`);
      const json = await res.json();
      state.cache.set(path,json);
      return json;
    }

    function setActiveLink(selector){
      document.querySelectorAll('.scene-link.active').forEach(a=>a.classList.remove('active'));
      if (selector){
        const node = document.querySelector(selector);
        node?.classList.add('active');
        node?.closest('details')?.setAttribute('open','');
      }
    }

    async function loadSceneByPath(path){
      // highlight active & open the play
      setActiveLink(`.scene-link[data-path="${CSS.escape(path)}"]`);

      // prev/next within the same play
      const loc = state.byPath.get(path);
      if (!loc) throw new Error(`Unknown scene: ${path}`);
      const play = state.index.plays[loc.playIndex];
      const prev = play.scenes[loc.sceneIndex-1];
      const next = play.scenes[loc.sceneIndex+1];
      $('#prev').disabled = !prev; $('#next').disabled = !next;
      $('#prev').onclick = prev ? ()=>navigateTo(prev.path) : null;
      $('#next').onclick = next ? ()=>navigateTo(next.path) : null;

      const key = `scene:${path}`;
      state.current = key;
      try {
        const json = await fetchJSON(path);
        renderScene(json);
      } catch(err){
        state.current = null;
        throw err;
      }
    }

    async function loadPlayById(id){
      const play = state.byPlay.get(id);
      if (!play) throw new Error(`Unknown play: ${id}`);
      setActiveLink(`.scene-link.full[data-play="${CSS.escape(id)}"]`);
      $('#prev').disabled = true; $('#next').disabled = true;
      $('#prev').onclick = null; $('#next').onclick = null;

      const key = `play:${id}`;
      state.current = key;
      try {
        const scenes = await Promise.all(play.scenes.map(s=>fetchJSON(s.path)));
        if (!scenes.length) throw new Error(`Play has no scenes: ${id}`);
        const items = scenes.flatMap(s=>s.items || []);
        const combined = {
          meta: { play: scenes[0].meta?.play },
          items
        };
        renderScene(combined,{playTitle:play.title, unitTitle:'Full Play'});
      } catch(err){
        state.current = null;
        throw err;
      }
    }

    function navigateTo(path){ location.hash = '#s=' + encodeURIComponent(path); }
    function navigateToPlay(id){ location.hash = '#p=' + encodeURIComponent(id); }
    function hashState(){
      const scene = location.hash.match(/#s=([^&]+)/);
      if (scene) return {type:'scene', value:decodeURIComponent(scene[1])};
      const play = location.hash.match(/#p=([^&]+)/);
      if (play) return {type:'play', value:decodeURIComponent(play[1])};
      return null;
    }

    function showError(err){
      const content = $('#content'); content.innerHTML = '';
      content.appendChild(el('div',{class:'error'}, `⚠️ ${err.message}\nOpen DevTools → Console for details.`));
      console.error(err);
    }

    window.addEventListener('hashchange', ()=>{
      const target = hashState();
      if (!target) return;
      const key = `${target.type}:${target.value}`;
      if (key === state.current) return;
      const loader = target.type === 'scene' ? loadSceneByPath(target.value) : loadPlayById(target.value);
      Promise.resolve(loader).catch(showError);
    });

    window.addEventListener('keydown', e=>{
      if (e.key==='ArrowLeft' && !$('#prev').disabled) $('#prev').click();
      if (e.key==='ArrowRight' && !$('#next').disabled) $('#next').click();
    });

    (async function start(){
      await loadIndex();
      state.byPlay.clear();
      state.index.plays.forEach(p=>state.byPlay.set(p.id,p));
      renderSidebar();
      let target = hashState();
      if (!target){
        const firstPlay = state.index.plays[0];
        if (firstPlay){
          navigateToPlay(firstPlay.id);
          target = {type:'play', value:firstPlay.id};
        }
      }
      if (target){
        if (target.type==='scene') await loadSceneByPath(target.value);
        else await loadPlayById(target.value);
      }
    })().catch(showError);
  })();
  </script>
</body>
</html>
